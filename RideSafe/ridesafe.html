<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RideSafe - Book Your Ride</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};gapi.load('auth2', function(){ gapi.auth2.init({client_id: 'YOUR_GOOGLE_CLIENT_ID'}); });"></script>
    <style>
        /* RideSafe CSS: Soft Off-White, Tesla-Red Edges, Max Legibility (WCAG AA+) */
        :root {
            --bg-primary: #fdf9f7;
            --bg-fade: #f9e9e8;
            --text-charcoal: #1f1f1f;
            --red-brand: #E31937;
            --red-glow: rgba(227, 25, 55, 0.2);
            --border-thin: 1px solid var(--red-brand);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            background-image: radial-gradient(circle at top left, var(--bg-fade) 0%, transparent 70%), radial-gradient(circle at bottom right, var(--bg-fade) 0%, transparent 70%);
            color: var(--text-charcoal);
            line-height: 1.7;
            padding: 1rem;
            min-height: 100vh;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .app { max-width: 600px; margin: 0 auto; }

        header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 1rem 0;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .tesla-icon { font-size: 2rem; cursor: pointer; transition: transform 0.2s ease; color: var(--red-brand); }
        .tesla-icon:hover { transform: scale(1.1); }
        .driver-btn { background: none; border: none; color: var(--red-brand); font-size: 0.9rem; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; }
        .driver-btn.show { opacity: 1; }

        form { display: flex; flex-direction: column; gap: 1.5rem; animation: slideUp 0.5s ease-out 0.2s both; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        label { font-weight: bold; font-size: 16px; display: block; margin-bottom: 0.5rem; }
        input, select { font-size: 14px; padding: 0.75rem; border: var(--border-thin); border-radius: 8px; transition: box-shadow 0.2s ease; background: white; width: 100%; }
        input:focus, select:focus { outline: none; box-shadow: 0 0 0 3px var(--red-glow); }

        .autocomplete { position: relative; }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: var(--border-thin); border-top: none; border-radius: 0 0 8px 8px; max-height: 150px; overflow-y: auto; z-index: 10; opacity: 0; transition: opacity 0.2s ease; }
        .suggestions.show { opacity: 1; }
        .suggestion { padding: 0.75rem; cursor: pointer; border-bottom: var(--border-thin); transition: background 0.2s ease; }
        .suggestion:hover { background: var(--red-glow); }
        .suggestion:last-child { border-bottom: none; }

        .price-display { text-align: center; font-size: 18px; font-weight: bold; margin: 1rem 0; padding: 1rem; border: var(--border-thin); border-radius: 8px; background: white; animation: pulse 0.5s ease-out; }
        @keyframes pulse { 0% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .book-btn { background: var(--red-brand); color: white; font-weight: bold; font-size: 16px; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s ease; }
        .book-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .book-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .loading { opacity: 0.7; pointer-events: none; }
        .hidden { display: none; }

        /* Mobile-First */
        @media (max-width: 480px) { body { padding: 0.5rem; } header { flex-direction: column; gap: 1rem; } .suggestions { position: fixed; left: 1rem; right: 1rem; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase Config (Your Provided)
        const firebaseConfig = {
            apiKey: "AIzaSyDC22Z2fuGTc7j9Gm7JKO5dB2NJTiHGIB0",
            authDomain: "ridesafe-app-2faa9.firebaseapp.com",
            databaseURL: "https://ridesafe-app-2faa9-default-rtdb.firebaseio.com/", // Ensure RTDB created in console
            projectId: "ridesafe-app-2faa9",
            storageBucket: "ridesafe-app-2faa9.appspot.com",
            messagingSenderId: "516451873273",
            appId: "1:516451873273:web:0bd8e6027b72c1e0580d28"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // EmailJS Init (Updated Service ID; Swap Template/Public Keys)
        emailjs.init('YOUR_PUBLIC_KEY');

        // Locations Autocomplete
        const locations = ['Baton Rouge', 'Country Club (LSU)', 'Kokadrie', 'Shreveport', 'New Orleans', 'Lafayette'];

        // Get Distance (Google API; Mock Fallback)
        const getDistance = async (origin, dest) => {
            const apiKey = 'YOUR_MAPS_API_KEY'; // Swap after setup
            try {
                // Real API (Uncomment Post-Key)
                // const response = await fetch(`https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(dest)}&key=${apiKey}`);
                // const data = await response.json();
                // if (data.status !== 'OK') throw new Error(data.status);
                // return data.rows[0].elements[0];

                // Mock for Demo
                const mocks = {
                    'Baton Rouge': { 
                        'New Orleans': { distance: { value: 80 * 1609.34 }, duration: { value: 75 * 60 } }, 
                        'Lafayette': { distance: { value: 60 * 1609.34 }, duration: { value: 60 * 60 } },
                        'Shreveport': { distance: { value: 240 * 1609.34 }, duration: { value: 210 * 60 } }
                    },
                    'Kokadrie': { 'Baton Rouge': { distance: { value: 15 * 1609.34 }, duration: { value: 20 * 60 } } },
                    // Expand as needed
                };
                return mocks[origin]?.[dest] || { distance: { value: 10 * 1609.34 }, duration: { value: 15 * 60 } };
            } catch (err) {
                console.error('Distance API error:', err);
                return { distance: { value: 10 * 1609.34 }, duration: { value: 15 * 60 } };
            }
        };

        // Get Ride Dist from Country Club (for Mult) - Simplified Mock; Real: Geocode Origin to Coords
        const getDistFromBase = async (origin) => {
            // Mock distances from CC
            const baseMocks = { 'Baton Rouge': 5, 'Kokadrie': 20, 'Shreveport': 220, 'New Orleans': 80, 'Lafayette': 55 };
            return baseMocks[origin] || 10; // mi fallback
        };

        // Surge Mult
        const getSurge = (dateStr, timeStr) => {
            const dt = new Date(`${dateStr}T${timeStr}:00`);
            const hour = dt.getHours() + (dt.getMinutes() / 60);
            const day = dt.getDay();
            if (hour >= 16.5 && hour <= 18.5 && day >= 1 && day <= 5) return 1.4;
            if (day === 5 && hour >= 17) return 1.6;
            if ((day === 0 || day === 6) && hour >= 20) return 1.8;
            return 1;
        };

        // Price Calc
        const calcPrice = async (origin, dest, date, time) => {
            if (!origin || !dest || !date || !time) return 0;
            const { distance, duration } = await getDistance(origin, dest);
            const miles = distance.value / 1609.34;
            const mins = duration.value / 60;
            const base = 1.05 + (1.05 * miles) + (0.15 * mins);
            const baseDist = await getDistFromBase(origin);
            const distMult = baseDist <= 10 ? 1 : baseDist <= 20 ? 1.25 : baseDist <= 35 ? 1.42 : 2;
            const surge = getSurge(date, time);
            return Math.round((base * distMult * surge) * 100) / 100;
        };

        // Main App Component
        const RideSafeApp = () => {
            const [formData, setFormData] = useState({
                name: localStorage.getItem('rs_name') || '',
                email: localStorage.getItem('rs_email') || '',
                phone: localStorage.getItem('rs_phone') || '',
                origin: localStorage.getItem('rs_origin') || '',
                dest: localStorage.getItem('rs_dest') || '',
                date: localStorage.getItem('rs_date') || '',
                time: localStorage.getItem('rs_time') || '',
                price: 0
            });
            const [suggestions, setSuggestions] = useState({ origin: [], dest: [] });
            const [loading, setLoading] = useState(false);
            const [showDriver, setShowDriver] = useState(false);

            useEffect(() => {
                Object.entries(formData).forEach(([k, v]) => localStorage.setItem(`rs_${k}`, v));
                if (formData.origin && formData.dest && formData.date && formData.time) {
                    setLoading(true);
                    calcPrice(formData.origin, formData.dest, formData.date, formData.time).then(price => {
                        setFormData(p => ({ ...p, price }));
                        setLoading(false);
                    }).catch(() => setLoading(false));
                }
            }, [formData.origin, formData.dest, formData.date, formData.time]);

            const handleInput = (e) => {
                const { name, value } = e.target;
                setFormData(p => ({ ...p, [name]: value }));
                if (['origin', 'dest'].includes(name)) {
                    const suggs = value ? locations.filter(l => l.toLowerCase().includes(value.toLowerCase())) : [];
                    setSuggestions(p => ({ ...p, [name]: suggs }));
                }
            };

            const selectSuggestion = (key, val) => {
                setFormData(p => ({ ...p, [key]: val }));
                setSuggestions(p => ({ ...p, [key]: [] }));
            };

            const bookRide = async (e) => {
                e.preventDefault();
                if (!formData.price) return alert('Fill all fields for quote.');
                setLoading(true);
                try {
                    // EmailJS Confirm (Updated Service ID)
                    await emailjs.send('service_2ss0i0l', 'YOUR_TEMPLATE_ID', {
                        name: formData.name, email: formData.email, phone: formData.phone,
                        origin: formData.origin, dest: formData.dest, date: formData.date,
                        time: formData.time, price: formData.price
                    }, 'YOUR_PUBLIC_KEY');

                    // Google Calendar (OAuth)
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (!authInstance.isSignedIn.get()) {
                        await authInstance.signIn(); // Prompts consent
                    }
                    const token = authInstance.currentUser.get().getAuthResponse().access_token;
                    const endTime = new Date(new Date(`${formData.date}T${formData.time}:00`).getTime() + 60*60*1000).toISOString(); // +1hr est.
                    await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            summary: `RideSafe Booking: ${formData.origin} → ${formData.dest}`,
                            description: `Passenger: ${formData.name} (${formData.phone})\nEst: $${formData.price}\nPay end-of-ride.`,
                            start: { dateTime: `${formData.date}T${formData.time}:00`, timeZone: 'America/Chicago' },
                            end: { dateTime: endTime, timeZone: 'America/Chicago' }
                        })
                    });

                    // Firebase Archive
                    await db.ref('bookings').push({ ...formData, timestamp: Date.now() });

                    alert(`Booked! Email sent, calendar updated. Price: $${formData.price} (pay end).`);
                    setFormData({ ...formData, price: 0 }); // Reset
                } catch (err) {
                    console.error('Booking failed:', err);
                    alert('Issue—check console (keys?).');
                }
                setLoading(false);
            };

            if (loading) return <div className="app loading">Loading...</div>;

            return (
                <div className="app">
                    <header>
                        <div className="tesla-icon" onClick={() => location.reload()}>⚡</div>
                        <button className={`driver-btn ${showDriver ? 'show' : ''}`} onClick={() => { setShowDriver(!showDriver); console.log('Driver signup clicked'); }}>Become a Driver</button>
                    </header>
                    <form onSubmit={bookRide}>
                        <label htmlFor="name">Name</label>
                        <input id="name" name="name" value={formData.name} onChange={handleInput} placeholder="e.g., Rachel" required />

                        <label htmlFor="email">Email</label>
                        <input id="email" name="email" type="email" value={formData.email} onChange={handleInput} placeholder="rachel@example.com" required />

                        <label htmlFor="phone">Phone</label>
                        <input id="phone" name="phone" type="tel" value={formData.phone} onChange={handleInput} placeholder="(225) 123-4567" required />

                        <label htmlFor="origin">Leaving From (Baton Rouge Area)</label>
                        <div className="autocomplete">
                            <input id="origin" name="origin" value={formData.origin} onChange={handleInput} placeholder="e.g., Baton Rouge" required />
                            {suggestions.origin.length > 0 && <div className="suggestions show">{suggestions.origin.map(s => <div key={s} className="suggestion" onClick={() => selectSuggestion('origin', s)}>{s}</div>)}</div>}
                        </div>

                        <label htmlFor="dest">Going To</label>
                        <div className="autocomplete">
                            <input id="dest" name="dest" value={formData.dest} onChange={handleInput} placeholder="e.g., New Orleans" required />
                            {suggestions.dest.length > 0 && <div className="suggestions show">{suggestions.dest.map(s => <div key={s} className="suggestion" onClick={() => selectSuggestion('dest', s)}>{s}</div>)}</div>}
                        </div>

                        <label htmlFor="date">Date</label>
                        <input id="date" name="date" type="date" value={formData.date} onChange={handleInput} required />

                        <label htmlFor="time">Time</label>
                        <input id="time" name="time" type="time" value={formData.time} onChange={handleInput} required />

                        <div className="price-display">Est. Price: ${formData.price || 'Enter details'}</div>

                        <button type="submit" className="book-btn" disabled={!formData.price}>Book It (Pay End-of-Ride)</button>
                    </form>
                </div>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RideSafeApp />);
    </script>
</body>
</html>
