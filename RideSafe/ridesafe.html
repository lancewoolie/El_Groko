<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RideSafe - Book Your Ride</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* RideSafe CSS: Soft Off-White, Tesla-Red Edges, WCAG AA */
        :root {
            --bg-primary: #fdf9f7;
            --bg-gradient: radial-gradient(circle at top-left, #f9e9e8 0%, transparent 70%), radial-gradient(circle at bottom-right, #f9e9e8 0%, transparent 70%);
            --text-charcoal: #1f1f1f;
            --red-brand: #E31937;
            --red-glow: rgba(227, 25, 55, 0.2);
            --border-thin: 1px solid var(--red-brand);
            --contrast-min: 4.5; /* Enforced via tools like WAVE */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            background-image: var(--bg-gradient);
            color: var(--text-charcoal);
            line-height: 1.7;
            padding: 1rem;
            min-height: 100vh;
            transition: opacity 0.3s ease;
        }

        .app { max-width: 600px; margin: 0 auto; }

        header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 1rem 0;
        }

        .tesla-icon { font-size: 2rem; cursor: pointer; transition: transform 0.2s; }
        .tesla-icon:hover { transform: scale(1.1); }
        .driver-btn { background: none; border: none; color: var(--red-brand); font-size: 0.9rem; cursor: pointer; opacity: 0; transition: opacity 0.3s; }
        .driver-btn.show { opacity: 1; }

        form { display: flex; flex-direction: column; gap: 1.5rem; }
        label { font-weight: bold; font-size: 16px; display: block; margin-bottom: 0.5rem; }
        input, select { font-size: 14px; padding: 0.75rem; border: var(--border-thin); border-radius: 8px; transition: box-shadow 0.2s; background: white; }
        input:focus, select:focus { outline: none; box-shadow: 0 0 0 3px var(--red-glow); }
        .autocomplete { position: relative; }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: var(--border-thin); border-top: none; max-height: 150px; overflow-y: auto; z-index: 10; }
        .suggestion { padding: 0.5rem; cursor: pointer; }
        .suggestion:hover { background: var(--red-glow); }

        .price-display { text-align: center; font-size: 18px; font-weight: bold; margin: 1rem 0; padding: 1rem; border: var(--border-thin); border-radius: 8px; background: white; }
        .book-btn { background: var(--red-brand); color: white; font-weight: bold; font-size: 16px; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .book-btn:hover { transform: translateY(-2px); }
        .book-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .loading { opacity: 0.7; pointer-events: none; }
        .hidden { display: none; }

        /* Mobile-First: Stack, Touch-Friendly */
        @media (max-width: 480px) { body { padding: 0.5rem; } header { flex-direction: column; gap: 1rem; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Hardcoded Autocomplete List (Baton Rouge Focus)
        const locations = ['Baton Rouge', 'Kokadrie', 'Shreveport', 'New Orleans', 'Lafayette', 'Country Club (LSU)'];

        // Mock Distance Matrix (km to mi conversion; real: Google API key in fetch)
        const getDistance = async (origin, dest) => {
            // Mock for demo; replace with: fetch(`https://maps.googleapis.com/maps/api/distancematrix/json?origins=${origin}&destinations=${dest}&key=YOUR_API_KEY`)
            const mocks = { 'Baton Rouge': { 'New Orleans': { distance: { value: 80 * 1609 }, duration: { value: 75 * 60 } } }; // mi, min
            return mocks[origin]?.[dest] || { distance: { value: 10 * 1609 }, duration: { value: 15 * 60 } };
        };

        // Surge Multiplier
        const getSurge = (date, time) => {
            const hour = new Date(`${date}T${time}`).getHours();
            const day = new Date(date).getDay();
            if (hour >= 16.5 && hour < 18.5 && [1,2,3,4,5].includes(day)) return 1.4;
            if (day === 5 && hour >= 17) return 1.6;
            if ([0,6].includes(day) && hour >= 20) return 1.8;
            return 1;
        };

        // Price Calc: Base Uber + Distance Multiplier from Country Club
        const calcPrice = async (origin, dest, date, time) => {
            const { distance, duration } = await getDistance(origin, dest);
            const miles = distance.value / 1609;
            const mins = duration.value / 60;
            const base = 1.05 + (1.05 * miles) + (0.15 * mins);
            const distMult = miles <= 10 ? 1 : miles <= 20 ? 1.25 : miles <= 35 ? 1.42 : 2;
            const surge = getSurge(date, time);
            return Math.round((base * distMult * surge) * 100) / 100;
        };

        // Main App Component
        const RideSafeApp = () => {
            const [formData, setFormData] = useState({
                name: localStorage.getItem('rs_name') || '',
                email: localStorage.getItem('rs_email') || '',
                phone: localStorage.getItem('rs_phone') || '',
                origin: localStorage.getItem('rs_origin') || '',
                dest: localStorage.getItem('rs_dest') || '',
                date: '',
                time: '',
                price: 0
            });
            const [suggestions, setSuggestions] = useState({ origin: [], dest: [] });
            const [loading, setLoading] = useState(false);
            const [showDriver, setShowDriver] = useState(false);

            useEffect(() => {
                // Auto-save to localStorage
                Object.entries(formData).forEach(([k, v]) => localStorage.setItem(`rs_${k}`, v));
            }, [formData]);

            useEffect(() => {
                if (formData.origin && formData.dest && formData.date && formData.time) {
                    setLoading(true);
                    calcPrice(formData.origin, formData.dest, formData.date, formData.time).then(p => {
                        setFormData(prev => ({ ...prev, price: p }));
                        setLoading(false);
                    });
                }
            }, [formData.origin, formData.dest, formData.date, formData.time]);

            const handleInput = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'origin' || name === 'dest') {
                    const key = name;
                    setSuggestions(prev => ({ ...prev, [key]: value ? locations.filter(l => l.toLowerCase().includes(value.toLowerCase())) : [] }));
                }
            };

            const selectSuggestion = (key, val) => {
                setFormData(prev => ({ ...prev, [key]: val }));
                setSuggestions(prev => ({ ...prev, [key]: [] }));
            };

            const bookRide = async () => {
                setLoading(true);
                try {
                    // EmailJS: Replace with your service/template/public keys
                    await emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                        name: formData.name,
                        email: formData.email,
                        phone: formData.phone,
                        origin: formData.origin,
                        dest: formData.dest,
                        date: formData.date,
                        time: formData.time,
                        price: formData.price
                    }, 'YOUR_PUBLIC_KEY');

                    // Google Calendar: OAuth prompt + POST (user consents)
                    const token = await gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token; // Assumes gapi loaded
                    await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            summary: `RideSafe: ${formData.origin} to ${formData.dest}`,
                            start: { dateTime: `${formData.date}T${formData.time}:00` },
                            end: { dateTime: `${formData.date}T${formData.time}:00` }, // Adjust duration
                            description: `Pickup: ${formData.origin}, Drop: ${formData.dest}, Price: $${formData.price}`
                        })
                    });

                    // Firebase Realtime DB Archive (your config)
                    const dbRef = firebase.database().ref('bookings').push();
                    await dbRef.set({ ...formData, timestamp: Date.now() });

                    alert('Booked! Check email & calendar.');
                } catch (err) {
                    console.error('Booking failed:', err);
                    alert('Booking issue—check console.');
                }
                setLoading(false);
            };

            return (
                <div className="app">
                    <header>
                        <div className="tesla-icon" onClick={() => window.location.reload()}>⚡</div>
                        <button className={`driver-btn ${showDriver ? 'show' : ''}`} onClick={() => console.log('Driver signup clicked')}>Become a Driver</button>
                    </header>
                    <form onSubmit={(e) => { e.preventDefault(); bookRide(); }}>
                        <label htmlFor="name">Name</label>
                        <input id="name" name="name" value={formData.name} onChange={handleInput} required />

                        <label htmlFor="email">Email</label>
                        <input id="email" name="email" type="email" value={formData.email} onChange={handleInput} required />

                        <label htmlFor="phone">Phone</label>
                        <input id="phone" name="phone" type="tel" value={formData.phone} onChange={handleInput} required />

                        <label htmlFor="origin">Leaving From</label>
                        <div className="autocomplete">
                            <input id="origin" name="origin" value={formData.origin} onChange={handleInput} placeholder="e.g., Baton Rouge" required />
                            {suggestions.origin.length > 0 && (
                                <div className="suggestions">
                                    {suggestions.origin.map(s => <div key={s} className="suggestion" onClick={() => selectSuggestion('origin', s)}>{s}</div>)}
                                </div>
                            )}
                        </div>

                        <label htmlFor="dest">Going To</label>
                        <div className="autocomplete">
                            <input id="dest" name="dest" value={formData.dest} onChange={handleInput} placeholder="e.g., New Orleans" required />
                            {suggestions.dest.length > 0 && (
                                <div className="suggestions">
                                    {suggestions.dest.map(s => <div key={s} className="suggestion" onClick={() => selectSuggestion('dest', s)}>{s}</div>)}
                                </div>
                            )}
                        </div>

                        <label htmlFor="date">Date</label>
                        <input id="date" name="date" type="date" value={formData.date} onChange={handleInput} required />

                        <label htmlFor="time">Time</label>
                        <input id="time" name="time" type="time" value={formData.time} onChange={handleInput} required />

                        <div className="price-display">Estimated Price: ${loading ? 'Calculating...' : formData.price}</div>

                        <button type="submit" className="book-btn" disabled={loading || !formData.price}>Book It</button>
                    </form>
                </div>
            );
        };

        // Firebase + EmailJS + Google API Loads
        const script = document.createElement('script');
        script.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js';
        script.onload = () => {
            const firebaseConfig = { /* Your config here */ apiKey: "AIzaSyDC22Z2fuGTc7j9Gm7JKO5dB2NJTiHGIB0", authDomain: "ridesafe-app-2faa9.firebaseapp.com", projectId: "ridesafe-app-2faa9", /* etc. */ };
            firebase.initializeApp(firebaseConfig);
            // EmailJS: emailjs.init('YOUR_PUBLIC_KEY');
        };
        document.head.appendChild(script);

        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.onload = () => gapi.load('auth2', () => gapi.auth2.init({ client_id: 'YOUR_GOOGLE_CLIENT_ID' })); // Add your OAuth client ID
        document.head.appendChild(gapiScript);

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RideSafeApp />);
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</body>
</html>
